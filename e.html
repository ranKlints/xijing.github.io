<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>英文单词练习游戏</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6ecbf5 0%, #059ee3 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            padding: 20px;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        h1 {
            color: #ff6b35;
            font-size: 2.5rem;
            text-shadow: 2px 2px 0 #ffd166;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .subtitle {
            color: #06a0c9;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .game-mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.15);
        }

        .mode-btn.single {
            background-color: #4cd964;
            color: white;
        }

        .mode-btn.multi {
            background-color: #ff9500;
            color: white;
        }

        .mode-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .grade-unit-selector {
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4fd 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid #d4e9f7;
        }

        .selector-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .selector-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selector-item label {
            font-size: 1.1rem;
            font-weight: bold;
            color: #06a0c9;
            white-space: nowrap;
        }

        .grade-select, .unit-select, .timer-select {
            padding: 10px 15px;
            border: 2px solid #a2d9ff;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            color: #333;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .grade-select:focus, .unit-select:focus, .timer-select:focus {
            outline: none;
            border-color: #4cd964;
            box-shadow: 0 0 0 3px rgba(76, 217, 100, 0.2);
        }

        .grade-select:disabled, .unit-select:disabled, .timer-select:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .apply-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4cd964 0%, #3db55a 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(76, 217, 100, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .apply-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 217, 100, 0.4);
        }

        .apply-btn:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(to right, #a2d9ff, #c2e5ff);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .game-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #finalLeaderboard {
            background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%);
            border: 3px solid #ffd166;
            box-shadow: 0 8px 25px rgba(255, 209, 102, 0.3);
            animation: slideIn 0.5s ease-out;
        }

        #finalLeaderboard h3 {
            color: #ff6b35;
            font-size: 1.8rem;
            text-shadow: 1px 1px 0 #ffd166;
        }

        .champion {
            background: linear-gradient(135deg, #4cd964 0%, #3db55a 100%) !important;
            border: 3px solid #4cd964 !important;
            box-shadow: 0 8px 25px rgba(76, 217, 100, 0.4) !important;
            transform: scale(1.05);
            animation: championPulse 2s ease-in-out infinite;
        }

        @keyframes championPulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.08); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.9rem;
            color: #06a0c9;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 1.6rem;
            color: #ff6b35;
            font-weight: bold;
        }

        .game-area {
            background-color: #f8fbff;
            border-radius: 18px;
            padding: 25px;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            min-height: 350px;
        }

        /* 单人游戏区域 */
        .single-game {
            display: none;
        }

        .single-game.active {
            display: block;
        }

        .hint {
            text-align: center;
            font-size: 1.8rem;
            color: #ff6b35;
            margin-bottom: 25px;
            padding: 12px;
            background-color: #fff9e6;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .word-display {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 35px;
            flex-wrap: wrap;
        }

        .letter-slot {
            width: 55px;
            height: 65px;
            background-color: white;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            border: 3px dashed #a2d9ff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .letter-slot:hover {
            background-color: #f0f8ff;
        }

        .letter-slot.filled {
            border: 3px solid #4cd964;
            background-color: #e8f7eb;
        }

        .scrambled-letters {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .letter-btn {
            width: 50px;
            height: 50px;
            background-color: #ffd166;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.6rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 0 #e6b845;
            transition: all 0.2s ease;
            user-select: none;
        }

        .letter-btn:hover {
            background-color: #ffc745;
            transform: translateY(-3px);
        }

        .letter-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 0 #e6b845;
        }

        .letter-btn.disabled {
            background-color: #ddd;
            color: #aaa;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .control-btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn.skip {
            background-color: #8e8e93;
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        /* 多人游戏区域 */
        .multi-game {
            display: none;
        }

        .multi-game.active {
            display: block;
        }

        .players-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .player {
            background-color: white;
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            border: 4px solid transparent;
            transition: all 0.3s ease;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .player.active {
            border-color: #4cd964;
            box-shadow: 0 6px 20px rgba(76, 217, 100, 0.3);
        }

        .player.finished {
            border-color: #06a0c9;
            background-color: #f0f9ff;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .player-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #06a0c9;
        }

        .player-score {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ff6b35;
            background-color: #fff0e8;
            padding: 5px 12px;
            border-radius: 25px;
        }

        .player-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .player-hint {
            font-size: 1.2rem;
            color: #ff6b35;
            text-align: center;
            margin-bottom: 12px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 8px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-word {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .player-letters {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            flex-grow: 1;
            align-items: flex-start;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .player-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .player-btn.skip {
            background-color: #8e8e93;
            color: white;
        }

        .player-status {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: #4cd964;
            margin-top: 8px;
            padding: 6px;
            border-radius: 8px;
            background-color: #f0fff4;
        }

        .leaderboard {
            background-color: white;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .leaderboard h3 {
            text-align: center;
            color: #06a0c9;
            font-size: 1.6rem;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px dashed #e0e0e0;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #f8fbff;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .leaderboard-item:nth-child(1) {
            background-color: #fff9e6;
            border: 2px solid #ffd166;
        }

        .leaderboard-item:nth-child(2) {
            background-color: #f0f8ff;
            border: 2px solid #a2d9ff;
        }

        .leaderboard-item:nth-child(3) {
            background-color: #f8f0ff;
            border: 2px solid #c8a2ff;
        }

        .player-rank {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ff6b35;
            width: 35px;
            text-align: center;
        }

        .player-info {
            flex-grow: 1;
            margin-left: 15px;
        }

        .player-stats {
            font-size: 1.1rem;
            color: #06a0c9;
            font-weight: bold;
        }

        .game-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px 50px;
            border-radius: 22px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
            display: none;
            animation: popIn 0.5s ease-out;
            max-width: 450px;
            width: 90%;
        }

        .game-message.active {
            display: block;
        }

        .message-title {
            color: #ff6b35;
            font-size: 2.2rem;
            margin-bottom: 15px;
        }

        .message-content {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .message-btn {
            padding: 12px 35px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #4cd964;
            color: white;
        }

        .message-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            display: none;
        }

        .fireworks.active {
            display: block;
        }

        .firework {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            box-shadow: 0 0 8px 4px;
            animation: explode 1s ease-out forwards;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .shake {
            animation: shake 0.3s ease-in-out;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .players-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            .players-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .game-info {
                flex-direction: column;
                gap: 12px;
            }
        }

        @media (max-width: 992px) {
            .selector-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .selector-item {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .game-mode-selector {
                flex-direction: column;
                align-items: center;
            }

            .mode-btn {
                width: 100%;
                max-width: 280px;
            }

            .grade-select, .unit-select {
                width: 100%;
                max-width: 200px;
            }

            .letter-btn {
                width: 42px;
                height: 42px;
                font-size: 1.4rem;
            }

            .letter-slot {
                width: 42px;
                height: 52px;
                font-size: 1.7rem;
            }

            .controls {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            .control-btn {
                width: 100%;
                max-width: 280px;
                justify-content: center;
            }

            .players-container {
                grid-template-columns: 1fr;
            }

            .player {
                min-height: 280px;
            }
        }

        /* 微信浏览器提示遮罩层 */
        .wechat-mask {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .wechat-mask.show {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .wechat-mask-content {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
            color: #fff;
        }

        .wechat-mask-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .wechat-mask-icon {
            font-size: 80px;
            margin-bottom: 20px;
            color: #07c160;
        }

        .wechat-mask-text {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 30px;
            color: #e0e0e0;
        }

        .wechat-mask-arrow {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M10 80 L50 40 L90 80" stroke="%2307c160" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>') no-repeat center center;
            background-size: contain;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .wechat-mask-tip {
            font-size: 14px;
            color: #07c160;
            font-weight: bold;
            margin-top: 10px;
        }

        .wechat-mask-close {
            display: inline-block;
            padding: 15px 40px;
            background: #07c160;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3);
            transition: all 0.3s ease;
        }

        .wechat-mask-close:hover {
            background: #06ae56;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(7, 193, 96, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-gamepad"></i> 英文单词练习游戏</h1>
            <p class="subtitle">趣味拼词，提升英文单词拼写能力！</p>
        </header>
        
        <div class="game-mode-selector">
            <button class="mode-btn single active" id="singleModeBtn">
                <i class="fas fa-user"></i> 单人练习
            </button>
            <button class="mode-btn multi" id="multiModeBtn">
                <i class="fas fa-users"></i> 多人PK (2-4人)
            </button>
        </div>
        
        <div class="grade-unit-selector">
            <div class="selector-row">
                <div class="selector-item">
                    <label for="gradeSelect"><i class="fas fa-graduation-cap"></i> 选择年级：</label>
                    <select id="gradeSelect" class="grade-select">
                        <option value="">请选择年级</option>
                        <option value="3">三年级上册</option>
                        <option value="3L">三年级下册</option>
                        <option value="4">四年级上册</option>
                        <option value="4L">四年级下册</option>
                        <option value="5">五年级上册</option>
                        <option value="5L">五年级下册</option>
                        <option value="6">六年级上册</option>
                        <option value="6L">六年级下册</option>
                    </select>
                </div>
                <div class="selector-item">
                    <label for="unitSelect"><i class="fas fa-book"></i> 选择单元：</label>
                    <select id="unitSelect" class="unit-select">
                        <option value="">请先选择年级</option>
                    </select>
                </div>
                <div class="selector-item">
                    <label for="timerSelect"><i class="fas fa-clock"></i> 倒计时(分)：</label>
                    <select id="timerSelect" class="timer-select">
                        <option value="0">不限制</option>
                        <option value="1">1分钟</option>
                        <option value="2">2分钟</option>
                        <option value="3">3分钟</option>
                        <option value="5">5分钟</option>
                        <option value="10">10分钟</option>
                        <option value="15">15分钟</option>
                    </select>
                </div>
                <div class="selector-item">
                    <button class="apply-btn" id="applySettingsBtn" disabled>
                        <i class="fas fa-check"></i> 应用设置
                    </button>
                </div>
            </div>
        </div>
        
        <div class="game-info">
            <div class="info-item">
                <div class="info-label">当前单词</div>
                <div class="info-value" id="currentWord">1</div>
            </div>
            <div class="info-item">
                <div class="info-label">得分</div>
                <div class="info-value" id="score">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">倒计时</div>
                <div class="info-value" id="timerDisplay">--:--</div>
            </div>
            <div class="info-item">
                <div class="info-label">跳过次数</div>
                <div class="info-value" id="skipCount">3/3</div>
            </div>
            <div class="info-item">
                <div class="info-label">错误次数</div>
                <div class="info-value" id="errors">0/3</div>
            </div>
        </div>
        
        <!-- 单人游戏区域 -->
        <div class="game-area single-game active" id="singleGame">
            <div class="hint" id="hint">苹果</div>
            
            <div class="word-display" id="wordDisplay">
                <!-- 字母槽位将由JS动态生成 -->
            </div>
            
            <div class="scrambled-letters" id="scrambledLetters">
                <!-- 打乱的字母按钮将由JS动态生成 -->
            </div>
            
            <div class="controls">
                <button class="control-btn skip" id="skipBtn">
                    <i class="fas fa-forward"></i> 跳过单词 (3次错误后)
                </button>
            </div>
        </div>
        
        <!-- 多人游戏区域 -->
        <div class="game-area multi-game" id="multiGame">
            <div class="game-container">
            
                <div class="players-container" id="playersContainer">
                    <!-- 玩家区域将由JS动态生成 -->
                </div>
            </div>
            <div class="leaderboard" id="finalLeaderboard" style="display: none;">
                <h3><i class="fas fa-trophy"></i> 最终排名</h3>
                <div class="leaderboard-list" id="leaderboard">
                    <!-- 最终排行榜将由JS动态生成 -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 西京小学英文单词练习游戏 | 支持1-6年级分单元学习 | 提示：先选择年级和单元 | 王斌开发作品</p>
        </footer>
    </div>

    <!-- 微信浏览器提示遮罩层 -->
    <div class="wechat-mask" id="wechatMask">
        <div class="wechat-mask-arrow"></div>
        <div class="wechat-mask-content">
            <div class="wechat-mask-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="wechat-mask-title">提示</div>
            <div class="wechat-mask-text">
                为了获得最佳游戏体验，建议使用浏览器打开
                <br><br>
                <span class="wechat-mask-tip">
                    点击右上角 ··· 按钮<br>
                    选择"在浏览器中打开"
                </span>
            </div>
            <button class="wechat-mask-close" onclick="closeWechatMask()">
                我知道了
            </button>
        </div>
    </div>

    <!-- 游戏消息弹窗 -->
    <div class="game-message" id="gameMessage">
        <div class="message-title" id="messageTitle">恭喜！</div>
        <div class="message-content" id="messageContent"></div>
        <button class="message-btn" id="messageBtn">继续</button>
    </div>
    
    <!-- 烟花效果容器 -->
    <div class="fireworks" id="fireworks"></div>
    
    <!-- 成功音效 -->
    <audio id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
    <!-- 错误音效 -->
    <audio id="errorSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" preload="auto"></audio>
    
    <script>
 // 按年级和单元组织的单词库 - 基于人教版PEP三年级起点教材
        const gradeWordLibrary = {
            3: {
                units: {
                    1: [
                        { word: "RULER", hint: "尺子" },
                        { word: "PENCIL", hint: "铅笔" },
                        { word: "ERASER", hint: "橡皮" },
                        { word: "CRAYON", hint: "蜡笔" },
                        { word: "BAG", hint: "包" },
                        { word: "PEN", hint: "钢笔" },
                        { word: "BOOK", hint: "书" },
                        { word: "PENCILBOX", hint: "铅笔盒" }
                    ],
                    2: [
                        { word: "RED", hint: "红色" },
                        { word: "YELLOW", hint: "黄色" },
                        { word: "GREEN", hint: "绿色" },
                        { word: "BLUE", hint: "蓝色" },
                        { word: "BLACK", hint: "黑色" },
                        { word: "BROWN", hint: "棕色" },
                        { word: "WHITE", hint: "白色" },
                        { word: "ORANGE", hint: "橙色" }
                    ],
                    3: [
                        { word: "FACE", hint: "脸" },
                        { word: "EAR", hint: "耳朵" },
                        { word: "EYE", hint: "眼睛" },
                        { word: "NOSE", hint: "鼻子" },
                        { word: "MOUTH", hint: "嘴" },
                        { word: "ARM", hint: "胳膊" },
                        { word: "HAND", hint: "手" },
                        { word: "HEAD", hint: "头" },
                        { word: "BODY", hint: "身体" },
                        { word: "LEG", hint: "腿" },
                        { word: "FOOT", hint: "脚" }
                    ],
                    4: [
                        { word: "DUCK", hint: "鸭子" },
                        { word: "PIG", hint: "猪" },
                        { word: "CAT", hint: "猫" },
                        { word: "BEAR", hint: "熊" },
                        { word: "DOG", hint: "狗" },
                        { word: "ELEPHANT", hint: "大象" },
                        { word: "MONKEY", hint: "猴子" },
                        { word: "BIRD", hint: "鸟" },
                        { word: "TIGER", hint: "老虎" },
                        { word: "PANDA", hint: "大熊猫" },
                        { word: "ZOO", hint: "动物园" }
                    ],
                    5: [
                        { word: "BREAD", hint: "面包" },
                        { word: "JUICE", hint: "果汁" },
                        { word: "EGG", hint: "蛋" },
                        { word: "MILK", hint: "牛奶" },
                        { word: "WATER", hint: "水" },
                        { word: "CAKE", hint: "蛋糕" },
                        { word: "FISH", hint: "鱼" },
                        { word: "RICE", hint: "米饭" }
                    ],
                    6: [
                        { word: "ONE", hint: "一" },
                        { word: "TWO", hint: "二" },
                        { word: "THREE", hint: "三" },
                        { word: "FOUR", hint: "四" },
                        { word: "FIVE", hint: "五" },
                        { word: "SIX", hint: "六" },
                        { word: "SEVEN", hint: "七" },
                        { word: "EIGHT", hint: "八" },
                        { word: "NINE", hint: "九" },
                        { word: "TEN", hint: "十" },
                        { word: "BROTHER", hint: "兄弟" },
                        { word: "PLATE", hint: "盘子" }
                    ]
                }
            },
            4: {
                units: {
                    1: [
                        { word: "CLASSROOM", hint: "教室" },
                        { word: "WINDOW", hint: "窗户" },
                        { word: "BLACKBOARD", hint: "黑板" },
                        { word: "LIGHT", hint: "电灯" },
                        { word: "PICTURE", hint: "图画" },
                        { word: "DOOR", hint: "门" },
                        { word: "COMPUTER", hint: "计算机" },
                        { word: "FAN", hint: "风扇" },
                        { word: "WALL", hint: "墙" },
                        { word: "FLOOR", hint: "地板" }
                    ],
                    2: [
                        { word: "SCHOOLBAG", hint: "书包" },
                        { word: "MATHSBOOK", hint: "数学书" },
                        { word: "ENGLISHBOOK", hint: "英语书" },
                        { word: "CHINESEBOOK", hint: "语文书" },
                        { word: "STORYBOOK", hint: "故事书" },
                        { word: "CANDY", hint: "糖果" },
                        { word: "NOTEBOOK", hint: "笔记本" },
                        { word: "TOY", hint: "玩具" },
                        { word: "KEY", hint: "钥匙" }
                    ],
                    3: [
                        { word: "STRONG", hint: "强壮的" },
                        { word: "FRIENDLY", hint: "友好的" },
                        { word: "QUIET", hint: "安静的" },
                        { word: "HAIR", hint: "头发" },
                        { word: "SHOE", hint: "鞋" },
                        { word: "GLASSES", hint: "眼镜" }
                    ],
                    4: [
                        { word: "BEDROOM", hint: "卧室" },
                        { word: "LIVINGROOM", hint: "客厅" },
                        { word: "STUDY", hint: "书房" },
                        { word: "KITCHEN", hint: "厨房" },
                        { word: "BATHROOM", hint: "浴室" },
                        { word: "BED", hint: "床" },
                        { word: "PHONE", hint: "电话" },
                        { word: "TABLE", hint: "桌子" },
                        { word: "SOFA", hint: "长沙发" },
                        { word: "FRIDGE", hint: "冰箱" }
                    ],
                    5: [
                        { word: "BEEF", hint: "牛肉" },
                        { word: "CHICKEN", hint: "鸡肉" },
                        { word: "NOODLES", hint: "面条" },
                        { word: "SOUP", hint: "汤" },
                        { word: "VEGETABLE", hint: "蔬菜" },
                        { word: "CHOPSTICKS", hint: "筷子" },
                        { word: "BOWL", hint: "碗" },
                        { word: "FORK", hint: "餐叉" },
                        { word: "KNIFE", hint: "刀" },
                        { word: "SPOON", hint: "勺" }
                    ],
                    6: [
                        { word: "PARENTS", hint: "父母" },
                        { word: "COUSIN", hint: "同辈表亲" },
                        { word: "UNCLE", hint: "舅父；叔父；伯父；姑父；姨父" },
                        { word: "AUNT", hint: "姑母；姨母" },
                        { word: "BABYBROTHER", hint: "婴儿小弟弟" },
                        { word: "DOCTOR", hint: "医生" },
                        { word: "COOK", hint: "厨师" },
                        { word: "DRIVER", hint: "司机" },
                        { word: "FARMER", hint: "农民" },
                        { word: "NURSE", hint: "护士" }
                    ]
                }
            },
            "3L": {
                units: {
                    1: [
                        { word: "UK", hint: "英国" },
                        { word: "CANADA", hint: "加拿大" },
                        { word: "USA", hint: "美国" },
                        { word: "CHINA", hint: "中国" },
                        { word: "SHE", hint: "她" },
                        { word: "HE", hint: "他" },
                        { word: "STUDENT", hint: "学生" },
                        { word: "PUPIL", hint: "学生（尤指小学生）" },
                        { word: "TEACHER", hint: "教师" },
                        { word: "BOY", hint: "男孩" },
                        { word: "GIRL", hint: "女孩" },
                        { word: "NEW", hint: "新的" },
                        { word: "FRIEND", hint: "朋友" },
                        { word: "TODAY", hint: "今天" }
                    ],
                    2: [
                        { word: "FATHER", hint: "父亲；爸爸" },
                        { word: "MOTHER", hint: "母亲；妈妈" },
                        { word: "MAN", hint: "男人" },
                        { word: "WOMAN", hint: "女人" },
                        { word: "SISTER", hint: "姐；妹" },
                        { word: "GRANDMOTHER", hint: "（外）祖母；奶奶/外婆" },
                        { word: "GRANDFATHER", hint: "（外）祖父；爷爷/外公" },
                        { word: "FAMILY", hint: "家；家庭" }
                    ],
                    3: [
                        { word: "THIN", hint: "瘦的" },
                        { word: "FAT", hint: "胖的" },
                        { word: "TALL", hint: "高的" },
                        { word: "SHORT", hint: "矮的；短的" },
                        { word: "LONG", hint: "长的" },
                        { word: "SMALL", hint: "小的" },
                        { word: "BIG", hint: "大的" },
                        { word: "GIRAFFE", hint: "长颈鹿" },
                        { word: "SO", hint: "这么；那么" },
                        { word: "CHILDREN", hint: "（child的复数）儿童" },
                        { word: "TAIL", hint: "尾巴" }
                    ],
                    4: [
                        { word: "ON", hint: "在…上" },
                        { word: "IN", hint: "在…里" },
                        { word: "UNDER", hint: "在…下" },
                        { word: "CHAIR", hint: "椅子" },
                        { word: "DESK", hint: "书桌" },
                        { word: "CAP", hint: "帽子" },
                        { word: "BALL", hint: "球" },
                        { word: "CAR", hint: "小汽车" },
                        { word: "BOAT", hint: "小船" },
                        { word: "MAP", hint: "地图" },
                        { word: "TOY", hint: "玩具" },
                        { word: "BOX", hint: "盒；箱" }
                    ],
                    5: [
                        { word: "PEAR", hint: "梨" },
                        { word: "APPLE", hint: "苹果" },
                        { word: "ORANGE", hint: "橙子" },
                        { word: "BANANA", hint: "香蕉" },
                        { word: "WATERMELON", hint: "西瓜" },
                        { word: "STRAWBERRY", hint: "草莓" },
                        { word: "GRAPE", hint: "葡萄" },
                        { word: "BUY", hint: "买" },
                        { word: "FRUIT", hint: "水果" }
                    ],
                    6: [
                        { word: "ELEVEN", hint: "十一" },
                        { word: "TWELVE", hint: "十二" },
                        { word: "THIRTEEN", hint: "十三" },
                        { word: "FOURTEEN", hint: "十四" },
                        { word: "FIFTEEN", hint: "十五" },
                        { word: "SIXTEEN", hint: "十六" },
                        { word: "SEVENTEEN", hint: "十七" },
                        { word: "EIGHTEEN", hint: "十八" },
                        { word: "NINETEEN", hint: "十九" },
                        { word: "TWENTY", hint: "二十" },
                        { word: "KITE", hint: "风筝" },
                        { word: "BEAUTIFUL", hint: "美丽的" }
                    ]
                }
            },
            "4L": {
                units: {
                    1: [
                        { word: "FIRSTFLOOR", hint: "一楼" },
                        { word: "SECONDFLOOR", hint: "二楼" },
                        { word: "TEACHERSOFFICE", hint: "教师办公室" },
                        { word: "LIBRARY", hint: "图书馆" },
                        { word: "PLAYGROUND", hint: "操场" },
                        { word: "COMPUTERROOM", hint: "计算机房" },
                        { word: "ARTROOM", hint: "美术教室" },
                        { word: "MUSICROOM", hint: "音乐教室" },
                        { word: "NEXTTO", hint: "紧邻" },
                        { word: "HOMEWORK", hint: "作业" },
                        { word: "CLASS", hint: "班级" }
                    ],
                    2: [
                        { word: "BREAKFAST", hint: "早餐" },
                        { word: "LUNCH", hint: "午餐" },
                        { word: "DINNER", hint: "晚餐" },
                        { word: "ENGLISHCLASS", hint: "英语课" },
                        { word: "MUSICCLASS", hint: "音乐课" },
                        { word: "PECLASS", hint: "体育课" },
                        { word: "GETUP", hint: "起床" },
                        { word: "GOTOSCHOOL", hint: "去上学" },
                        { word: "GOHOME", hint: "回家" },
                        { word: "GOTOBED", hint: "上床睡觉" }
                    ],
                    3: [
                        { word: "COLD", hint: "寒冷的" },
                        { word: "COOL", hint: "凉爽的" },
                        { word: "WARM", hint: "温暖的" },
                        { word: "HOT", hint: "热的" },
                        { word: "SUNNY", hint: "阳光充足的" },
                        { word: "WINDY", hint: "多风的" },
                        { word: "CLOUDY", hint: "阴天的" },
                        { word: "SNOWY", hint: "下雪的" },
                        { word: "RAINY", hint: "阴雨的" },
                        { word: "OUTSIDE", hint: "在户外" }
                    ],
                    4: [
                        { word: "TOMATO", hint: "西红柿" },
                        { word: "POTATO", hint: "马铃薯" },
                        { word: "GREENBEANS", hint: "豆角" },
                        { word: "CARROT", hint: "胡萝卜" },
                        { word: "HORSE", hint: "马" },
                        { word: "COW", hint: "奶牛" },
                        { word: "SHEEP", hint: "羊" },
                        { word: "HEN", hint: "母鸡" },
                        { word: "THESE", hint: "这些" },
                        { word: "THOSE", hint: "那些" },
                        { word: "ANIMAL", hint: "动物" }
                    ],
                    5: [
                        { word: "CLOTHES", hint: "衣服" },
                        { word: "PANTS", hint: "裤子" },
                        { word: "HAT", hint: "帽子" },
                        { word: "DRESS", hint: "连衣裙" },
                        { word: "SKIRT", hint: "女裙" },
                        { word: "COAT", hint: "外衣" },
                        { word: "SWEATER", hint: "毛衣" },
                        { word: "SOCK", hint: "短袜" },
                        { word: "SHORTS", hint: "短裤" },
                        { word: "JACKET", hint: "夹克衫" },
                        { word: "SHIRT", hint: "衬衫" }
                    ],
                    6: [
                        { word: "GLOVES", hint: "手套" },
                        { word: "UMBRELLA", hint: "伞" },
                        { word: "SUNGLASSES", hint: "太阳镜" },
                        { word: "SCARF", hint: "围巾" },
                        { word: "PRETTY", hint: "美观的" },
                        { word: "EXPENSIVE", hint: "昂贵的" },
                        { word: "CHEAP", hint: "便宜的" },
                        { word: "NICE", hint: "好的" },
                        { word: "TRYON", hint: "试穿" },
                        { word: "SIZE", hint: "尺码" }
                    ]
                }
            },
            5: {
                units: {
                    1: [
                        { word: "OLD", hint: "年老的" },
                        { word: "YOUNG", hint: "年轻的" },
                        { word: "FUNNY", hint: "滑稽的；可笑的" },
                        { word: "KIND", hint: "和蔼的；亲切的" },
                        { word: "STRICT", hint: "严格的" },
                        { word: "POLITE", hint: "有礼貌的" },
                        { word: "HARDWORKING", hint: "工作努力的" },
                        { word: "HELPFUL", hint: "有用的；愿意帮忙的" },
                        { word: "CLEVER", hint: "聪明的" },
                        { word: "SHY", hint: "羞怯的；腼腆的" }
                    ],
                    2: [
                        { word: "MONDAY", hint: "星期一" },
                        { word: "TUESDAY", hint: "星期二" },
                        { word: "WEDNESDAY", hint: "星期三" },
                        { word: "THURSDAY", hint: "星期四" },
                        { word: "FRIDAY", hint: "星期五" },
                        { word: "SATURDAY", hint: "星期六" },
                        { word: "SUNDAY", hint: "星期日" },
                        { word: "WEEKEND", hint: "周末" },
                        { word: "WASH", hint: "洗" },
                        { word: "WATCH", hint: "看" },
                        { word: "DO", hint: "做；干" },
                        { word: "READ", hint: "看；读" },
                        { word: "PLAY", hint: "玩；踢（球等）" }
                    ],
                    3: [
                        { word: "SANDWICH", hint: "三明治" },
                        { word: "SALAD", hint: "蔬菜沙拉" },
                        { word: "HAMBURGER", hint: "汉堡包" },
                        { word: "ICECREAM", hint: "冰淇淋" },
                        { word: "TEA", hint: "茶" },
                        { word: "FRESH", hint: "新鲜的" },
                        { word: "HEALTHY", hint: "健康的" },
                        { word: "DELICIOUS", hint: "美味的" },
                        { word: "HOT", hint: "辣的" },
                        { word: "SWEET", hint: "甜的" },
                        { word: "DRINK", hint: "喝；饮品" }
                    ],
                    4: [
                        { word: "DANCE", hint: "跳舞" },
                        { word: "SING", hint: "唱；唱歌" },
                        { word: "DRAW", hint: "画" },
                        { word: "COOK", hint: "烹调" },
                        { word: "SWIM", hint: "游泳" },
                        { word: "PLAYBASKETBALL", hint: "打篮球" },
                        { word: "SPEAKENGLISH", hint: "说英语" },
                        { word: "PINGPONG", hint: "乒乓球" }
                    ],
                    5: [
                        { word: "CLOCK", hint: "时钟" },
                        { word: "PLANT", hint: "植物" },
                        { word: "BOTTLE", hint: "瓶子" },
                        { word: "PHOTO", hint: "照片" },
                        { word: "BIKE", hint: "自行车" },
                        { word: "FRONT", hint: "正面" },
                        { word: "BETWEEN", hint: "在……中间" },
                        { word: "ABOVE", hint: "在……上面" },
                        { word: "BESIDE", hint: "在旁边" },
                        { word: "BEHIND", hint: "在……后面" }
                    ],
                    6: [
                        { word: "FOREST", hint: "森林" },
                        { word: "RIVER", hint: "河流" },
                        { word: "LAKE", hint: "湖泊" },
                        { word: "MOUNTAIN", hint: "高山" },
                        { word: "HILL", hint: "山丘" },
                        { word: "TREE", hint: "树" },
                        { word: "BRIDGE", hint: "桥" },
                        { word: "BUILDING", hint: "建筑物" },
                        { word: "VILLAGE", hint: "村庄" },
                        { word: "HOUSE", hint: "房子" }
                    ]
                }
            },
            "5L": {
                units: {
                    1: [
                        { word: "EATBREAKFAST", hint: "吃早饭" },
                        { word: "HAVECLASS", hint: "上……课" },
                        { word: "PLAYSPORTS", hint: "进行体育运动" },
                        { word: "EXERCISE", hint: "活动；运动" },
                        { word: "DOMORNINGEXERCISES", hint: "做早操" },
                        { word: "EATDINNER", hint: "吃晚饭" },
                        { word: "CLEANMYROOM", hint: "打扫我的房间" },
                        { word: "GOFORAWALK", hint: "散步" },
                        { word: "GOSHOPPING", hint: "购物" },
                        { word: "TAKE", hint: "学习；上（课）" },
                        { word: "DANCING", hint: "跳舞" },
                        { word: "WHEN", hint: "什么时候" }
                    ],
                    2: [
                        { word: "SPRING", hint: "春天" },
                        { word: "SUMMER", hint: "夏天" },
                        { word: "AUTUMN", hint: "秋天" },
                        { word: "WINTER", hint: "冬天" },
                        { word: "SEASON", hint: "季节" },
                        { word: "PICNIC", hint: "野餐" },
                        { word: "GOONAPICNIC", hint: "去野餐" },
                        { word: "PICK", hint: "摘；采集" },
                        { word: "PICKAPPLES", hint: "摘苹果" },
                        { word: "SNOWMAN", hint: "雪人" },
                        { word: "MAKEASNOWMAN", hint: "堆雪人" },
                        { word: "GOSWIMMING", hint: "去游泳" }
                    ],
                    3: [
                        { word: "JANUARY", hint: "一月" },
                        { word: "FEBRUARY", hint: "二月" },
                        { word: "MARCH", hint: "三月" },
                        { word: "APRIL", hint: "四月" },
                        { word: "MAY", hint: "五月" },
                        { word: "JUNE", hint: "六月" },
                        { word: "JULY", hint: "七月" },
                        { word: "AUGUST", hint: "八月" },
                        { word: "SEPTEMBER", hint: "九月" },
                        { word: "OCTOBER", hint: "十月" },
                        { word: "NOVEMBER", hint: "十一月" },
                        { word: "DECEMBER", hint: "十二月" }
                    ],
                    4: [
                        { word: "FIRST", hint: "第一" },
                        { word: "SECOND", hint: "第二" },
                        { word: "THIRD", hint: "第三" },
                        { word: "FOURTH", hint: "第四" },
                        { word: "FIFTH", hint: "第五" },
                        { word: "TWELFTH", hint: "第十二" },
                        { word: "TWENTIETH", hint: "第二十" },
                        { word: "TWENTYFIRST", hint: "第二十一" },
                        { word: "TWENTYTHIRD", hint: "第二十三" },
                        { word: "THIRTIETH", hint: "第三十" }
                    ],
                    5: [
                        { word: "MINE", hint: "我的" },
                        { word: "YOURS", hint: "你（们）的" },
                        { word: "HIS", hint: "他的" },
                        { word: "HERS", hint: "她的" },
                        { word: "THEIRS", hint: "他们的；她们的；它们的" },
                        { word: "OURS", hint: "我们的" },
                        { word: "CLIMBING", hint: "正在攀爬" },
                        { word: "EATING", hint: "正在吃" },
                        { word: "PLAYING", hint: "正在玩" },
                        { word: "JUMPING", hint: "正在跳" },
                        { word: "DRINKING", hint: "正在喝" },
                        { word: "SLEEPING", hint: "正在睡觉" }
                    ],
                    6: [
                        { word: "DOINGMORNINGEXERCISES", hint: "正在做早操" },
                        { word: "HAVINGCLASS", hint: "正在上……课" },
                        { word: "READINGABOOK", hint: "正在看书" },
                        { word: "LISTENINGTOMUSIC", hint: "正在听音乐" },
                        { word: "KEEP", hint: "保持某种状态" },
                        { word: "KEEPTORIGHT", hint: "靠右" },
                        { word: "KEEPYOURDESKCLEAN", hint: "保持你的课桌整洁" },
                        { word: "TALKQUIETLY", hint: "小声说话" },
                        { word: "TURN", hint: "顺序" },
                        { word: "TAKETURNS", hint: "按顺序来" }
                    ]
                }
            },
            6: {
                units: {
                    1: [
                        { word: "SCIENCEMUSEUM", hint: "科学博物馆" },
                        { word: "POSTOFFICE", hint: "邮局" },
                        { word: "BOOKSTORE", hint: "书店" },
                        { word: "CINEMA", hint: "电影院" },
                        { word: "HOSPITAL", hint: "医院" },
                        { word: "CROSSING", hint: "十字路口" },
                        { word: "TURN", hint: "转弯" },
                        { word: "LEFT", hint: "左" },
                        { word: "RIGHT", hint: "右" },
                        { word: "STRAIGHT", hint: "笔直地" }
                    ],
                    2: [
                        { word: "ONFOOT", hint: "步行" },
                        { word: "BYBUS", hint: "乘公共汽车" },
                        { word: "BYPLANE", hint: "乘飞机" },
                        { word: "BYTAXI", hint: "乘出租车" },
                        { word: "BYSHIP", hint: "乘船" },
                        { word: "BYSUBWAY", hint: "乘地铁" },
                        { word: "BYTRAIN", hint: "乘火车" },
                        { word: "SLOWDOWN", hint: "慢下来" },
                        { word: "STOP", hint: "停下" },
                        { word: "WAIT", hint: "等待" }
                    ],
                    3: [
                        { word: "VISIT", hint: "拜访" },
                        { word: "FILM", hint: "电影" },
                        { word: "SEEAFILM", hint: "看电影" },
                        { word: "TRIP", hint: "旅行" },
                        { word: "TAKEATRIP", hint: "去旅行" },
                        { word: "SUPERMARKET", hint: "超市" },
                        { word: "EVENING", hint: "晚上；傍晚" },
                        { word: "TONIGHT", hint: "在今晚" },
                        { word: "TOMORROW", hint: "明天" },
                        { word: "NEXTWEEK", hint: "下周" },
                        { word: "DICTIONARY", hint: "词典" },
                        { word: "COMICBOOK", hint: "连环画册" },
                        { word: "WORDBOOK", hint: "单词书" }
                    ],
                    4: [
                        { word: "STUDIES", hint: "（study的第三人称单数形式）学习" },
                        { word: "PUZZLE", hint: "谜" },
                        { word: "HIKING", hint: "远足" },
                        { word: "DOES", hint: "（do的第三人称单数形式）" },
                        { word: "PENPAL", hint: "笔友" },
                        { word: "HOBBY", hint: "业余爱好" },
                        { word: "JASMINE", hint: "茉莉" },
                        { word: "IDEA", hint: "想法；主意" },
                        { word: "AMAZING", hint: "令人惊奇的" }
                    ],
                    5: [
                        { word: "FACTORY", hint: "工厂" },
                        { word: "WORKER", hint: "工人" },
                        { word: "POSTMAN", hint: "邮递员" },
                        { word: "BUSINESSMAN", hint: "商人；企业家" },
                        { word: "POLICEOFFICER", hint: "警察" },
                        { word: "FISHERMAN", hint: "渔民" },
                        { word: "SCIENTIST", hint: "科学家" },
                        { word: "PILOT", hint: "飞行员" },
                        { word: "COACH", hint: "教练" },
                        { word: "COUNTRY", hint: "国家" }
                    ],
                    6: [
                        { word: "ANGRY", hint: "生气的" },
                        { word: "AFRAID", hint: "害怕的" },
                        { word: "SAD", hint: "难过的" },
                        { word: "WORRIED", hint: "担心的；发愁的" },
                        { word: "HAPPY", hint: "高兴的" },
                        { word: "SEEADOCTOR", hint: "看病" },
                        { word: "WEAR", hint: "穿" },
                        { word: "MORE", hint: "更多的" },
                        { word: "DEEP", hint: "深的" },
                        { word: "BREATH", hint: "呼吸" },
                        { word: "TAKEADEEPBREATH", hint: "深深吸一口气" },
                        { word: "COUNT", hint: "数数" },
                        { word: "COUNTTOTEN", hint: "数到十" }
                    ]
                }
            },
            "6L": {
                units: {
                    1: [
                        { word: "TALLER", hint: "更高的" },
                        { word: "SHORTER", hint: "更矮的" },
                        { word: "STRONGER", hint: "更强壮的" },
                        { word: "OLDER", hint: "更年长的" },
                        { word: "YOUNGER", hint: "更年轻的" },
                        { word: "BIGGER", hint: "更大的" },
                        { word: "HEAVIER", hint: "更重的" },
                        { word: "LONGER", hint: "更长的" },
                        { word: "THINNER", hint: "更瘦的" },
                        { word: "SMALLER", hint: "更小的" }
                    ],
                    2: [
                        { word: "CLEANED", hint: "打扫" },
                        { word: "STAYED", hint: "待；停留" },
                        { word: "WASHED", hint: "洗" },
                        { word: "WATCHED", hint: "看" },
                        { word: "HAD", hint: "得病；患病" },
                        { word: "SLEPT", hint: "睡觉" },
                        { word: "READ", hint: "读" },
                        { word: "SAW", hint: "看见" },
                        { word: "LAST", hint: "最近的；上一个的" },
                        { word: "YESTERDAY", hint: "昨天" },
                        { word: "BEFORE", hint: "在……之前" }
                    ],
                    3: [
                        { word: "WENT", hint: "去" },
                        { word: "CAMPING", hint: "野营" },
                        { word: "WENTCAMPING", hint: "去野营" },
                        { word: "FISH", hint: "钓鱼；捕鱼" },
                        { word: "WENTFISHING", hint: "去钓鱼" },
                        { word: "RODE", hint: "骑" },
                        { word: "HURT", hint: "（使）受伤" },
                        { word: "ATE", hint: "吃" },
                        { word: "TOOK", hint: "拍照" },
                        { word: "TOOKPICTURES", hint: "拍照" },
                        { word: "BOUGHT", hint: "买" },
                        { word: "GIFT", hint: "礼物" }
                    ],
                    4: [
                        { word: "DININGHALL", hint: "饭厅" },
                        { word: "GRASS", hint: "草坪" },
                        { word: "GYM", hint: "体育馆" },
                        { word: "AGO", hint: "以前" },
                        { word: "CYCLING", hint: "骑自行车运动" },
                        { word: "GOCYCLING", hint: "去骑自行车" },
                        { word: "ICESKATE", hint: "滑冰" },
                        { word: "BADMINTON", hint: "羽毛球运动" },
                        { word: "DREAM", hint: "梦" }
                    ]
                }
            }
        };

        // 当前选中的年级和单元
        let selectedGrade = "";
        let selectedUnit = "";
        let currentWordLibrary = []; // 当前使用的单词库

        // 游戏状态变量
        let gameMode = "single"; // "single" 或 "multi"
        let score = 0;
        let errors = 0;
        let maxErrors = 3;
        let currentWord = "";
        let currentHint = "";
        let scrambledLetters = [];
        let userWord = [];
        let selectedLetterIndices = []; // 存储已选字母的索引
        let gameActive = true;
        let players = [];
        let playerCount = 2; // 默认2个玩家
        let gameTimer = 0;
        let timerInterval = null;
        let countdownTime = 0; // 倒计时时间（秒）
        let countdownInterval = null; // 倒计时定时器
        let gameEnded = false; // 游戏是否结束
        
        // 单人模式特定变量
        let singlePlayerWordIndex = 0; // 单人模式当前单词索引
        let singlePlayerSkips = 0; // 单人模式跳过次数
        let maxSkips = 3; // 最大跳过次数
        
        // 多人游戏特定变量
        let multiplayerGameActive = false; // 多人游戏是否正在进行

        // DOM元素
        const singleModeBtn = document.getElementById("singleModeBtn");
        const multiModeBtn = document.getElementById("multiModeBtn");
        const singleGame = document.getElementById("singleGame");
        const multiGame = document.getElementById("multiGame");
        const currentWordEl = document.getElementById("currentWord");
        const scoreEl = document.getElementById("score");
        const errorsEl = document.getElementById("errors");
        const hintEl = document.getElementById("hint");
        const wordDisplayEl = document.getElementById("wordDisplay");
        const scrambledLettersEl = document.getElementById("scrambledLetters");
        const skipBtn = document.getElementById("skipBtn");
        const gameMessage = document.getElementById("gameMessage");
        const messageTitle = document.getElementById("messageTitle");
        const messageContent = document.getElementById("messageContent");
        const messageBtn = document.getElementById("messageBtn");
        const fireworksEl = document.getElementById("fireworks");
        const successSound = document.getElementById("successSound");
        const errorSound = document.getElementById("errorSound");
        const playersContainer = document.getElementById("playersContainer");
        const leaderboardEl = document.getElementById("leaderboard");
        const finalLeaderboard = document.getElementById("finalLeaderboard");
        
        // 年级单元选择器相关DOM元素
        const gradeSelect = document.getElementById("gradeSelect");
        const unitSelect = document.getElementById("unitSelect");
        const timerSelect = document.getElementById("timerSelect");
        const applySettingsBtn = document.getElementById("applySettingsBtn");
        const timerDisplayEl = document.getElementById("timerDisplay");

        // 初始化游戏
        function initGame() {
            // 检查是否已选择年级
            if (!selectedGrade) {
                showMessage("请先选择年级", "请在上方选择年级后开始游戏。年级是必选项，单元是可选项。");
                return;
            }
            
            // 重置游戏状态
            score = 0;
            errors = 0;
            gameActive = true;
            userWord = [];
            selectedLetterIndices = [];
            
            // 构建当前单词库
            buildCurrentWordLibrary();
            
            // 检查单词库是否为空
            if (currentWordLibrary.length === 0) {
                showMessage("单词库为空", "所选年级和单元没有找到单词，请重新选择。");
                return;
            }
            
            // 更新UI
            updateGameInfo();
            
            // 重置游戏结束状态
            gameEnded = false;
            
            // 根据游戏模式初始化
            if (gameMode === "single") {
                initSinglePlayerGame();
            } else {
                initMultiplayerGame();
            }
            
            // 开始倒计时
            startCountdown();
            
            // 开始计时器（仅多人模式）
            if (gameMode === "multi") {
                startTimer();
            }
        }

        // 构建当前单词库
        function buildCurrentWordLibrary() {
            currentWordLibrary = [];
            
            if (selectedGrade && gradeWordLibrary[selectedGrade]) {
                if (selectedUnit && gradeWordLibrary[selectedGrade].units[selectedUnit]) {
                    // 如果选择了特定单元，使用该单元的单词
                    currentWordLibrary = gradeWordLibrary[selectedGrade].units[selectedUnit];
                } else {
                    // 如果没有选择单元，使用该年级所有单元的单词
                    const gradeData = gradeWordLibrary[selectedGrade];
                    for (let unit in gradeData.units) {
                        currentWordLibrary = currentWordLibrary.concat(gradeData.units[unit]);
                    }
                }
            }
        }

        // 更新单元选择器
        function updateUnitSelector() {
            unitSelect.innerHTML = '<option value="">全部单元（随机）</option>';
            unitSelect.disabled = true;
            
            if (selectedGrade && gradeWordLibrary[selectedGrade]) {
                const units = gradeWordLibrary[selectedGrade].units;
                const unitNumbers = Object.keys(units).sort((a, b) => parseInt(a) - parseInt(b));
                
                unitNumbers.forEach(unit => {
                    const option = document.createElement("option");
                    option.value = unit;
                    option.textContent = `第${unit}单元`;
                    unitSelect.appendChild(option);
                });
                
                unitSelect.disabled = false;
            }
        }

        // 应用设置
        function applySettings() {
            selectedGrade = gradeSelect.value;
            selectedUnit = unitSelect.value;
            
            if (!selectedGrade) {
                showMessage("请选择年级", "年级是必选项，请选择一个年级后再开始游戏。");
                return;
            }
            
            // 获取倒计时设置
            countdownTime = parseInt(timerSelect.value) * 60; // 转换为秒
            
            // 获取年级显示名称
            let gradeName = "";
            switch(selectedGrade) {
                case "3": gradeName = "三年级上册"; break;
                case "3L": gradeName = "三年级下册"; break;
                case "4": gradeName = "四年级上册"; break;
                case "4L": gradeName = "四年级下册"; break;
                case "5": gradeName = "五年级上册"; break;
                case "5L": gradeName = "五年级下册"; break;
                case "6": gradeName = "六年级上册"; break;
                case "6L": gradeName = "六年级下册"; break;
                default: gradeName = selectedGrade; break;
            }
            
            // 构建单词库
            buildCurrentWordLibrary();
            
            if (currentWordLibrary.length === 0) {
                showMessage("单词库为空", "所选年级和单元没有找到单词，请重新选择。");
                return;
            }
            
            const timerText = countdownTime > 0 ? `倒计时${timerSelect.value}分钟` : "无时间限制";
            showMessage("设置成功", `已选择${gradeName}${selectedUnit ? `第${selectedUnit}单元` : '所有单元'}，包含${currentWordLibrary.length}个单词，${timerText}。现在可以开始游戏了！`);
            
            // 如果游戏已经开始，重新初始化游戏
            if (gameActive) {
                initGame();
            }
        }

        // 检查是否可以应用设置
        function checkApplyButton() {
            if (gradeSelect.value) {
                applySettingsBtn.disabled = false;
            } else {
                applySettingsBtn.disabled = true;
            }
        }

        // 开始倒计时
        function startCountdown() {
            if (countdownTime <= 0) {
                timerDisplayEl.textContent = "--:--";
                return;
            }
            
            clearInterval(countdownInterval);
            let remainingTime = countdownTime;
            
            countdownInterval = setInterval(() => {
                if (remainingTime <= 0 || gameEnded) {
                    clearInterval(countdownInterval);
                    timerDisplayEl.textContent = "00:00";
                    endGame();
                    return;
                }
                
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                timerDisplayEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // 最后10秒变红
                if (remainingTime <= 10 && remainingTime > 0) {
                    timerDisplayEl.style.color = "#ff6b35";
                    timerDisplayEl.style.fontWeight = "bold";
                }
                
                remainingTime--;
            }, 1000);
        }

        // 停止倒计时
        function stopCountdown() {
            clearInterval(countdownInterval);
            timerDisplayEl.textContent = "--:--";
            timerDisplayEl.style.color = "#ff6b35";
        }

        // 结束游戏
        function endGame() {
            if (gameEnded) return;
            gameEnded = true;
            gameActive = false;
            
            if (gameMode === "single") {
                // 单人模式结束
                showSinglePlayerResults();
            } else {
                // 多人模式结束
                showMultiplayerResults();
            }
        }

        // 显示单人模式结果
        function showSinglePlayerResults() {
            stopCountdown();
            showMessage("游戏结束！", `恭喜！你完成了挑战！\n最终得分：${score}分\n完成单词数：${singlePlayerWordIndex}`);
            createFireworks();
        }

        // 显示多人模式结果
        function showMultiplayerResults() {
            stopCountdown();
            
            // 按分数排序玩家
            const sortedPlayers = [...players].sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return b.completedWords - a.completedWords;
            });
            
            // 显示最终排名
            finalLeaderboard.style.display = "block";
            leaderboardEl.innerHTML = "";
            
            sortedPlayers.forEach((player, index) => {
                const item = document.createElement("div");
                const isChampion = index === 0;
                item.className = `leaderboard-item ${isChampion ? 'champion' : ''}`;
                
                const medalEmoji = index === 0 ? "🏆" : index === 1 ? "🥈" : index === 2 ? "🥉" : "";
                
                item.innerHTML = `
                    <div class="player-rank">${medalEmoji || index + 1}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name} ${isChampion ? '👑 冠军！' : ''}</div>
                        <div class="player-stats">得分: ${player.score} | 单词: ${player.completedWords}</div>
                    </div>
                `;
                
                leaderboardEl.appendChild(item);
            });
            
            // 禁用所有玩家的操作
            players.forEach(player => {
                player.isActive = false;
                updatePlayerStatus(player.id);
            });
            
            // 显示烟花效果
            createFireworks();
            
            showMessage("游戏结束！", `恭喜${sortedPlayers[0].name}获得冠军！\n得分：${sortedPlayers[0].score}分 | 完成单词：${sortedPlayers[0].completedWords}个`);
        }

        // 显示消息
        function showMessage(title, content) {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            gameMessage.classList.add("active");
        }

        // 初始化单人游戏
        function initSinglePlayerGame() {
            // 重置单词索引
            singlePlayerWordIndex = 0;
            
            // 重置跳过次数
            singlePlayerSkips = 0;
            updateSkipDisplay();
            
            // 加载第一个单词（随机选择）
            loadRandomWordForSinglePlayer();
        }

        // 为单人游戏随机加载单词
        function loadRandomWordForSinglePlayer() {
            if (!gameActive || currentWordLibrary.length === 0) return;
            
            // 随机选择一个单词
            const randomIndex = Math.floor(Math.random() * currentWordLibrary.length);
            const wordData = currentWordLibrary[randomIndex];
            currentWord = wordData.word.toLowerCase(); // 转为小写
            currentHint = wordData.hint;
            
            // 重置用户输入
            userWord = [];
            selectedLetterIndices = [];
            
            // 打乱字母顺序
            scrambledLetters = scrambleWord(currentWord);
            
            // 更新UI
            updateWordDisplay();
            updateScrambledLetters();
            
            hintEl.textContent = currentHint;
            currentWordEl.textContent = singlePlayerWordIndex + 1;
        }

        // 初始化多人游戏
        function initMultiplayerGame() {
            // 创建玩家
            players = [];
            for (let i = 0; i < playerCount; i++) {
                players.push({
                    id: i,
                    name: `玩家 ${i + 1}`,
                    score: 0,
                    currentWord: "",
                    currentHint: "",
                    currentWordLetters: [],
                    selectedLetterIndices: [],
                    completedWords: 0,
                    errors: 0,
                    skips: 0, // 添加跳过次数计数
                    scrambledLetters: [],
                    isActive: true, // 玩家是否还在游戏中
                    status: "准备中..."
                });
            }
            
            // 生成玩家界面
            renderPlayers();
            
            // 更新排行榜
            updateLeaderboard();
            
            // 为所有玩家分配随机单词
            assignRandomWordsToPlayers();
            
            // 设置多人游戏为活跃状态
            multiplayerGameActive = true;
        }

        // 为所有玩家分配随机单词
        function assignRandomWordsToPlayers() {
            players.forEach(player => {
                if (player.isActive) {
                    // 为每个玩家随机分配一个不同的单词
                    assignRandomWordToPlayer(player.id);
                }
            });
        }

        // 为单个玩家分配随机单词
        function assignRandomWordToPlayer(playerId) {
            const player = players[playerId];
            
            // 检查当前单词库是否为空
            if (currentWordLibrary.length === 0) {
                player.status = "等待设置年级...";
                updatePlayerUI(playerId);
                return;
            }
            
            // 随机选择一个单词
            const randomIndex = Math.floor(Math.random() * currentWordLibrary.length);
            const wordData = currentWordLibrary[randomIndex];
            player.currentWord = wordData.word.toLowerCase(); // 转为小写
            player.currentHint = wordData.hint;
            player.currentWordLetters = [];
            player.selectedLetterIndices = [];
            player.scrambledLetters = scrambleWord(wordData.word);
            player.status = "游戏中...";
            
            // 更新玩家的UI
            updatePlayerUI(playerId);
        }

        // 更新游戏信息显示
        function updateGameInfo() {
            if (gameMode === "single") {
                currentWordEl.textContent = singlePlayerWordIndex + 1;
            }
            
            scoreEl.textContent = score;
            errorsEl.textContent = `${errors}/${maxErrors}`;
        }

        // 打乱单词字母顺序
        function scrambleWord(word) {
            const letters = word.toLowerCase().split('');
            console.log('原始单词:', word, ' -> 小写字母:', letters);
            for (let i = letters.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [letters[i], letters[j]] = [letters[j], letters[i]];
            }
            return letters;
        }

        // 更新单词显示区域
        function updateWordDisplay() {
            wordDisplayEl.innerHTML = "";
            
            for (let i = 0; i < currentWord.length; i++) {
                const letterSlot = document.createElement("div");
                letterSlot.className = "letter-slot";
                
                if (userWord[i]) {
                    letterSlot.textContent = userWord[i];
                    letterSlot.classList.add("filled");
                }
                
                // 添加点击事件，用于撤销字母
                letterSlot.addEventListener("click", () => {
                    if (userWord[i]) {
                        removeLetterFromWord(i);
                    }
                });
                
                wordDisplayEl.appendChild(letterSlot);
            }
        }

        // 从单词中移除字母（撤销功能）
        function removeLetterFromWord(index) {
            if (!gameActive || index >= userWord.length) return;
            
            // 找到该字母在打乱字母中的原始位置
            const letterToRemove = userWord[index];
            const removedIndex = selectedLetterIndices[index];
            
            // 从数组中移除
            userWord.splice(index, 1);
            selectedLetterIndices.splice(index, 1);
            
            // 更新显示
            console.log('选择字母:', letter, '当前userWord:', userWord);
            updateWordDisplay();
            updateScrambledLetters();
            
            // 如果是多人模式，更新当前玩家的单词
            if (gameMode === "multi") {
                updateCurrentPlayerWord();
            }
        }

        // 更新打乱字母区域
        function updateScrambledLetters() {
            scrambledLettersEl.innerHTML = "";
            
            scrambledLetters.forEach((letter, index) => {
                const letterBtn = document.createElement("button");
                letterBtn.className = "letter-btn";
                letterBtn.textContent = letter;
                letterBtn.dataset.index = index;
                letterBtn.dataset.letter = letter;
                
                // 检查该字母是否已被使用
                if (selectedLetterIndices.includes(index)) {
                    letterBtn.classList.add("disabled");
                } else {
                    letterBtn.addEventListener("click", () => selectLetter(letter, index));
                }
                
                scrambledLettersEl.appendChild(letterBtn);
            });
        }

        // 选择字母
        function selectLetter(letter, index) {
            if (!gameActive) return;
            
            // 如果单词已经拼写完整，不再接受输入
            if (userWord.length >= currentWord.length) return;
            
            // 检查该字母是否已被使用
            if (selectedLetterIndices.includes(index)) return;
            
            // 添加字母到用户单词
            userWord.push(letter);
            selectedLetterIndices.push(index);
            
            // 更新显示
            console.log('选择字母:', letter, '当前userWord:', userWord);
            updateWordDisplay();
            updateScrambledLetters();
            
            // 检查是否完成单词
            if (userWord.length === currentWord.length) {
                checkWord();
            }
        }

        // 检查单词是否正确
        function checkWord() {
            if (!gameActive || gameEnded) return;

            const userWordStr = userWord.join("");
            console.log('用户输入:', userWordStr, '当前单词:', currentWord, '是否匹配:', userWordStr === currentWord);

            if (userWordStr === currentWord) {
                // 单词正确
                score += 10;
                showSuccess();
                
                // 播放成功音效
                successSound.currentTime = 0;
                successSound.play();
                
                // 延迟后加载下一个单词
                setTimeout(() => {
                    if (gameMode === "single") {
                        // 单人模式
                        singlePlayerWordIndex++;
                        if (!gameEnded) {
                            loadRandomWordForSinglePlayer();
                            updateGameInfo();
                        }
                    }
                }, 1000);
            } else {
                // 单词错误
                errors++;
                showError();
                
                // 播放错误音效
                errorSound.currentTime = 0;
                errorSound.play();
                
                // 更新错误次数显示
                errorsEl.textContent = `${errors}/${maxErrors}`;
                
                // 如果错误次数达到上限，显示正确答案并跳过
                if (errors >= maxErrors) {
                    setTimeout(() => {
                        showCorrectAnswer();
                        setTimeout(() => {
                            if (gameMode === "single") {
                                // 单人模式
                                singlePlayerWordIndex++;
                                errors = 0;
                                if (!gameEnded) {
                                    loadRandomWordForSinglePlayer();
                                    updateGameInfo();
                                }
                            }
                        }, 2000);
                    }, 1000);
                }
            }
        }

        // 显示成功效果
        function showSuccess() {
            // 显示烟花效果
            createFireworks();
            
            // 如果是单人模式，显示成功提示
            if (gameMode === "single") {
                hintEl.innerHTML = `<span style="color:#4cd964;">✓ 正确！+10分</span>`;
            }
        }

        // 显示错误效果
        function showError() {
            // 震动效果
            if (gameMode === "single") {
                hintEl.classList.add("shake");
                setTimeout(() => hintEl.classList.remove("shake"), 300);
                hintEl.innerHTML = `<span style="color:#ff6b35;">✗ 再试试！</span>`;
            }
        }

        // 显示正确答案
        function showCorrectAnswer() {
            if (gameMode === "single") {
                hintEl.innerHTML = `<span style="color:#06a0c9;">正确答案: ${currentWord}</span>`;
            }
        }

        // 创建烟花效果
        function createFireworks() {
            fireworksEl.classList.add("active");
            
            // 创建多个烟花
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const firework = document.createElement("div");
                    firework.className = "firework";
                    
                    // 随机颜色
                    const colors = ["#ff6b35", "#4cd964", "#06a0c9", "#ffd166", "#c8a2ff"];
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.backgroundColor = color;
                    firework.style.boxShadow = `0 0 8px 4px ${color}`;
                    
                    // 随机位置
                    firework.style.left = `${Math.random() * 100}%`;
                    firework.style.top = `${Math.random() * 100}%`;
                    
                    fireworksEl.appendChild(firework);
                    
                    // 动画结束后移除元素
                    setTimeout(() => {
                        firework.remove();
                    }, 1000);
                }, i * 30);
            }
            
            // 隐藏烟花容器
            setTimeout(() => {
                fireworksEl.classList.remove("active");
                fireworksEl.innerHTML = "";
            }, 1500);
        }

        // 跳过当前单词
        function skipWord() {
            if (!gameActive) return;
            
            if (gameMode === "single") {
                // 单人模式 - 检查跳过次数限制
                if (singlePlayerSkips >= maxSkips) {
                    showMessage("跳过次数已用完", `你已经使用了全部${maxSkips}次跳过机会！`);
                    return;
                }
                
                singlePlayerSkips++;
                updateSkipDisplay();
                
                // 显示正确答案
                showCorrectAnswer();
                
                // 延迟后加载下一个单词
                setTimeout(() => {
                    if (!gameEnded) {
                        singlePlayerWordIndex++;
                        errors = 0;
                        loadRandomWordForSinglePlayer();
                        updateGameInfo();
                    }
                }, 1500);
            }
        }
        
        // 更新跳过次数显示
        function updateSkipDisplay() {
            const remainingSkips = maxSkips - singlePlayerSkips;
            document.getElementById("skipCount").textContent = `${remainingSkips}/${maxSkips}`;
            
            // 如果跳过次数用完，禁用跳过按钮
            const skipBtn = document.getElementById("skipBtn");
            if (remainingSkips <= 0) {
                skipBtn.disabled = true;
                skipBtn.style.opacity = "0.5";
                skipBtn.style.cursor = "not-allowed";
            } else {
                skipBtn.disabled = false;
                skipBtn.style.opacity = "1";
                skipBtn.style.cursor = "pointer";
            }
        }

        // 渲染玩家界面
        function renderPlayers() {
            playersContainer.innerHTML = "";
            
            // 根据玩家数量调整容器样式
            if (playerCount === 2) {
                playersContainer.style.gridTemplateColumns = "repeat(2, 1fr)";
            } else if (playerCount === 3) {
                playersContainer.style.gridTemplateColumns = "repeat(3, 1fr)";
            } else if (playerCount === 4) {
                playersContainer.style.gridTemplateColumns = "repeat(4, 1fr)";
            }
            
            players.forEach((player, index) => {
                const playerEl = document.createElement("div");
                playerEl.className = `player ${player.isActive ? 'active' : 'finished'}`;
                playerEl.id = `player-${player.id}`;
                
                playerEl.innerHTML = `
                    <div class="player-header">
                        <div class="player-name">${player.name}</div>
                        <div class="player-score">得分: ${player.score}</div>
                    </div>
                    <div class="player-area">
                        <div class="player-hint" id="player-hint-${player.id}">${player.currentHint || "等待分配单词..."}</div>
                        <div class="player-word" id="player-word-${player.id}"></div>
                        <div class="player-letters" id="player-letters-${player.id}"></div>
                        <div class="player-controls">
                            <button class="player-btn skip" onclick="skipWordMulti(${player.id})">
                                <i class="fas fa-forward"></i> 跳过 (3)
                            </button>
                        </div>
                        <div class="player-status" id="player-status-${player.id}">${player.status}</div>
                    </div>
                `;
                
                playersContainer.appendChild(playerEl);
            });
        }

        // 更新玩家的UI
        function updatePlayerUI(playerId) {
            const player = players[playerId];
            
            // 更新提示
            const hintEl = document.getElementById(`player-hint-${playerId}`);
            if (hintEl) {
                hintEl.textContent = player.currentHint;
            }
            
            // 更新字母按钮
            updatePlayerLetters(playerId);
            
            // 更新单词显示
            updatePlayerWord(playerId);
            
            // 更新状态
            updatePlayerStatus(playerId);
            
            // 更新排行榜
            updateLeaderboard();
        }

        // 更新特定玩家的字母按钮
        function updatePlayerLetters(playerId) {
            const player = players[playerId];
            const lettersEl = document.getElementById(`player-letters-${playerId}`);
            
            if (!lettersEl || !player.isActive) return;
            
            lettersEl.innerHTML = "";
            
            player.scrambledLetters.forEach((letter, index) => {
                const letterBtn = document.createElement("button");
                letterBtn.className = "letter-btn";
                letterBtn.textContent = letter;
                letterBtn.dataset.index = index;
                letterBtn.dataset.letter = letter;
                
                // 检查该字母是否已被当前玩家使用
                if (player.selectedLetterIndices.includes(index)) {
                    letterBtn.classList.add("disabled");
                } else {
                    // 只有活跃玩家可以点击自己的字母
                    if (player.isActive) {
                        letterBtn.addEventListener("click", () => selectLetterMulti(letter, index, playerId));
                    }
                }
                
                lettersEl.appendChild(letterBtn);
            });
        }

        // 更新特定玩家的单词显示
        function updatePlayerWord(playerId) {
            const player = players[playerId];
            const wordEl = document.getElementById(`player-word-${playerId}`);
            
            if (!wordEl) return;
            
            wordEl.innerHTML = "";
            
            for (let i = 0; i < player.currentWord.length; i++) {
                const letterSlot = document.createElement("div");
                letterSlot.className = "letter-slot";
                
                if (player.currentWordLetters[i]) {
                    letterSlot.textContent = player.currentWordLetters[i];
                    letterSlot.classList.add("filled");
                }
                
                // 添加点击事件，用于撤销字母
                letterSlot.addEventListener("click", () => {
                    if (player.currentWordLetters[i]) {
                        removeLetterFromWordMulti(i, playerId);
                    }
                });
                
                wordEl.appendChild(letterSlot);
            }
        }

        // 从多人模式单词中移除字母
        function removeLetterFromWordMulti(index, playerId) {
            if (!multiplayerGameActive) return;
            
            const player = players[playerId];
            
            if (!player.isActive || index >= player.currentWordLetters.length) return;
            
            // 从数组中移除
            player.currentWordLetters.splice(index, 1);
            player.selectedLetterIndices.splice(index, 1);
            
            // 更新玩家的单词显示
            updatePlayerWord(playerId);
            
            // 更新当前玩家的字母按钮
            updatePlayerLetters(playerId);
        }

        // 更新玩家状态显示
        function updatePlayerStatus(playerId) {
            const player = players[playerId];
            const statusEl = document.getElementById(`player-status-${playerId}`);
            
            if (statusEl) {
                statusEl.textContent = player.status;
                statusEl.style.color = player.isActive ? "#4cd964" : "#06a0c9";
            }
            
            // 更新玩家容器样式
            const playerEl = document.getElementById(`player-${playerId}`);
            if (playerEl) {
                playerEl.className = `player ${player.isActive ? 'active' : 'finished'}`;
            }
        }

        // 更新当前玩家的单词（用于单人模式切换到多人模式的情况）
        function updateCurrentPlayerWord() {
            if (gameMode === "multi") {
                // 这里不再需要，因为每个玩家独立
            }
        }

        // 多人模式选择字母
        function selectLetterMulti(letter, index, playerId) {
            if (!multiplayerGameActive) return;
            
            const player = players[playerId];
            
            if (!player.isActive) return;
            
            // 如果单词已经拼写完整，不再接受输入
            if (player.currentWordLetters.length >= player.currentWord.length) return;
            
            // 检查该字母是否已被使用
            if (player.selectedLetterIndices.includes(index)) return;
            
            // 添加字母到玩家单词
            player.currentWordLetters.push(letter);
            player.selectedLetterIndices.push(index);
            
            // 更新玩家的单词显示
            updatePlayerWord(playerId);
            
            // 更新当前玩家的字母按钮
            updatePlayerLetters(playerId);
            
            // 检查是否完成单词
            if (player.currentWordLetters.length === player.currentWord.length) {
                checkWordMulti(playerId);
            }
        }

        // 检查多人模式下单词是否正确
        function checkWordMulti(playerId) {
            if (!multiplayerGameActive || gameEnded) return;
            
            const player = players[playerId];
            const playerWordStr = player.currentWordLetters.join("");
            
            if (playerWordStr === player.currentWord) {
                // 单词正确
                player.score += 10;
                player.completedWords++;
                player.errors = 0; // 重置错误计数
                
                // 显示成功效果
                showSuccessMulti(playerId);
                
                // 播放成功音效
                successSound.currentTime = 0;
                successSound.play();
                
                // 为玩家分配下一个单词
                setTimeout(() => {
                    if (!gameEnded) {
                        assignRandomWordToPlayer(playerId);
                    }
                }, 1000);
            } else {
                // 单词错误
                player.errors++;
                
                // 显示错误效果
                showErrorMulti(playerId);
                
                // 播放错误音效
                errorSound.currentTime = 0;
                errorSound.play();
                
                // 如果错误次数达到上限，自动跳过
                if (player.errors >= maxErrors) {
                    setTimeout(() => {
                        // 为玩家分配下一个单词（跳过当前单词）
                        setTimeout(() => {
                            if (!gameEnded) {
                                assignRandomWordToPlayer(playerId);
                            }
                        }, 1000);
                    }, 1000);
                }
            }
        }

        // 显示多人模式成功效果
        function showSuccessMulti(playerId) {
            const player = players[playerId];
            const playerEl = document.getElementById(`player-${playerId}`);
            if (playerEl) {
                playerEl.style.borderColor = "#4cd964";
                
                // 更新玩家分数显示
                const scoreEl = playerEl.querySelector('.player-score');
                if (scoreEl) {
                    scoreEl.textContent = `得分: ${player.score}`;
                }
                
                // 短暂显示成功提示
                const hintEl = document.getElementById(`player-hint-${playerId}`);
                if (hintEl) {
                    hintEl.innerHTML = `<span style="color:#4cd964;">✓ 正确！+10分</span>`;
                }
                
                // 恢复原样
                setTimeout(() => {
                    playerEl.style.borderColor = "";
                    if (hintEl) {
                        hintEl.textContent = player.currentHint;
                    }
                }, 1000);
            }
        }

        // 显示多人模式错误效果
        function showErrorMulti(playerId) {
            const playerEl = document.getElementById(`player-${playerId}`);
            if (playerEl) {
                playerEl.classList.add("shake");
                
                // 显示错误提示
                const hintEl = document.getElementById(`player-hint-${playerId}`);
                if (hintEl) {
                    hintEl.innerHTML = `<span style="color:#ff6b35;">✗ 再试试！</span>`;
                }
                
                // 恢复原样
                setTimeout(() => {
                    playerEl.classList.remove("shake");
                    if (hintEl) {
                        hintEl.textContent = players[playerId].currentHint;
                    }
                }, 1000);
            }
        }

        // 多人模式下跳过单词
        window.skipWordMulti = function(playerId) {
            if (!multiplayerGameActive || gameEnded) return;
            
            const player = players[playerId];
            
            if (!player.isActive) return;
            
            // 检查跳过次数限制
            if (player.skips >= maxSkips) {
                // 禁用该玩家的跳过按钮
                const playerEl = document.getElementById(`player-${playerId}`);
                const skipBtn = playerEl.querySelector('.player-btn.skip');
                if (skipBtn) {
                    skipBtn.disabled = true;
                    skipBtn.style.opacity = "0.5";
                    skipBtn.style.cursor = "not-allowed";
                    skipBtn.title = "跳过次数已用完";
                }
                return;
            }
            
            player.skips++;
            updateSkipDisplayMulti(playerId);
            
            // 为玩家分配下一个单词（跳过当前单词）
            assignRandomWordToPlayer(playerId);
        };
        
        // 更新多人模式跳过次数显示
        function updateSkipDisplayMulti(playerId) {
            const player = players[playerId];
            const remainingSkips = maxSkips - player.skips;
            const playerEl = document.getElementById(`player-${playerId}`);
            const skipBtn = playerEl.querySelector('.player-btn.skip');
            
            if (skipBtn) {
                skipBtn.innerHTML = `<i class="fas fa-forward"></i> 跳过 (${remainingSkips})`;
                
                // 如果跳过次数用完，禁用按钮
                if (remainingSkips <= 0) {
                    skipBtn.disabled = true;
                    skipBtn.style.opacity = "0.5";
                    skipBtn.style.cursor = "not-allowed";
                    skipBtn.title = "跳过次数已用完";
                }
            }
        }

        // 更新排行榜（游戏结束时不调用，只显示最终排名）
        function updateLeaderboard() {
            // 暂时保留函数但不使用，避免在游戏过程中显示排名
        }

        // 开始计时器
        function startTimer() {
            gameTimer = 0;
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                gameTimer++;
            }, 1000);
        }

        // 事件监听器
        singleModeBtn.addEventListener("click", () => {
            gameMode = "single";
            singleModeBtn.classList.add("active");
            multiModeBtn.classList.remove("active");
            singleGame.classList.add("active");
            multiGame.classList.remove("active");
            
            // 重置为2个玩家（默认）
            playerCount = 2;
            
            initGame();
        });

        multiModeBtn.addEventListener("click", () => {
            gameMode = "multi";
            multiModeBtn.classList.add("active");
            singleModeBtn.classList.remove("active");
            multiGame.classList.add("active");
            singleGame.classList.remove("active");
            
            // 询问玩家数量
            const count = prompt("请输入玩家数量 (2-4):", "2");
            playerCount = parseInt(count) || 2;
            
            // 限制玩家数量在2-4之间
            if (playerCount < 2) playerCount = 2;
            if (playerCount > 4) playerCount = 4;
            
            initGame();
        });

        skipBtn.addEventListener("click", skipWord);

        messageBtn.addEventListener("click", () => {
            gameMessage.classList.remove("active");
        });

        // 年级单元选择器事件监听器
        gradeSelect.addEventListener("change", () => {
            selectedGrade = gradeSelect.value;
            updateUnitSelector();
            checkApplyButton();
        });

        unitSelect.addEventListener("change", () => {
            checkApplyButton();
        });

        timerSelect.addEventListener("change", () => {
            checkApplyButton();
        });

        applySettingsBtn.addEventListener("click", applySettings);

        // 检测微信浏览器
        function checkWechatBrowser() {
            // 微信浏览器的User Agent特征
            const isWechat = /micromessenger/i.test(navigator.userAgent);

            if (isWechat) {
                // 显示微信遮罩层
                const wechatMask = document.getElementById('wechatMask');
                if (wechatMask) {
                    wechatMask.classList.add('show');
                }
            }
        }

        // 关闭微信遮罩层
        function closeWechatMask() {
            const wechatMask = document.getElementById('wechatMask');
            if (wechatMask) {
                wechatMask.classList.remove('show');
            }
        }

        // 初始化游戏
        window.addEventListener("DOMContentLoaded", () => {
            // 检测微信浏览器
            checkWechatBrowser();

            // 显示欢迎提示
            showMessage("欢迎来到英文单词练习游戏", "请先选择年级（必选），然后可以选择具体单元（可选）。设置完成后即可开始游戏！");
        });
    </script>
</body>
</html>